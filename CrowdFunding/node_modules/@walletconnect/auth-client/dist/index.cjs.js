"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var x=require("@walletconnect/core"),q=require("@walletconnect/logger"),Ae=require("events"),R=require("@walletconnect/jsonrpc-utils"),T=require("@walletconnect/utils"),F=require("@walletconnect/time"),X=require("@ethersproject/hash"),ve=require("@ethersproject/transactions"),_e=require("isomorphic-unfetch"),Re=require("@stablelib/random"),Te=require("@stablelib/sha256");function Ie(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}var xe=Ie(_e);class J{constructor(r){this.client=r}}class H{constructor(r){this.opts=r}}const Y="https://rpc.walletconnect.com/v1",U={wc_authRequest:{req:{ttl:F.ONE_DAY,prompt:!0,tag:3e3},res:{ttl:F.ONE_DAY,prompt:!1,tag:3001}}},P={min:F.FIVE_MINUTES,max:F.SEVEN_DAYS},L="wc",G=1,Q="auth",M="authClient",N=`${L}@${1}:${Q}:`,I=`${N}:PUB_KEY`,Fe="expirer",Ue={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ne="0.3",Oe=F.ONE_DAY;function j(t){return t?.split(":")}function Se(t){const r=t&&j(t);if(r)return r[3]}function qe(t){const r=t&&j(t);if(r)return r[2]+":"+r[3]}function Z(t){const r=t&&j(t);if(r)return r.pop()}async function Pe(t,r,e,i,n){switch(e.t){case"eip191":return Be(t,r,e.s);case"eip1271":return await $e(t,r,e.s,i,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${e.t}`)}}function Be(t,r,e){return ve.recoverAddress(X.hashMessage(r),e).toLowerCase()===t.toLowerCase()}async function $e(t,r,e,i,n){try{const s="0x1626ba7e",u="0000000000000000000000000000000000000000000000000000000000000040",a="0000000000000000000000000000000000000000000000000000000000000041",o=e.substring(2),h=X.hashMessage(r).substring(2),D=s+h+u+a+o,p=await xe.default(`${Y}/?chainId=${i}&projectId=${n}`,{method:"POST",body:JSON.stringify({id:Le(),jsonrpc:"2.0",method:"eth_call",params:[{to:t,data:D},"latest"]})}),{result:E}=await p.json();return E?E.slice(0,s.length).toLowerCase()===s.toLowerCase():!1}catch(s){return console.error("isValidEip1271Signature: ",s),!1}}function Le(){return Date.now()+Math.floor(Math.random()*1e3)}function W(t){return t.getAll().filter(r=>"requester"in r)}function ee(t,r){return W(t).find(e=>e.id===r)}function Me(t){const r=T.isValidUrl(t.aud),e=new RegExp(`${t.domain}`).test(t.aud),i=!!t.nonce,n=t.type?t.type==="eip4361":!0,s=t.expiry;if(s&&!T.isValidRequestExpiry(s,P)){const{message:u}=T.getInternalError("MISSING_OR_INVALID",`request() expiry: ${s}. Expiry must be a number (in seconds) between ${P.min} and ${P.max}`);throw new Error(u)}return!!(r&&e&&i&&n)}function je(t,r){return!!ee(r,t.id)}function ze(t=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(t):new Uint8Array(t)}function Ke(t,r){if(t.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),i=0;i<e.length;i++)e[i]=255;for(var n=0;n<t.length;n++){var s=t.charAt(n),u=s.charCodeAt(0);if(e[u]!==255)throw new TypeError(s+" is ambiguous");e[u]=n}var a=t.length,o=t.charAt(0),h=Math.log(a)/Math.log(256),D=Math.log(256)/Math.log(a);function p(c){if(c instanceof Uint8Array||(ArrayBuffer.isView(c)?c=new Uint8Array(c.buffer,c.byteOffset,c.byteLength):Array.isArray(c)&&(c=Uint8Array.from(c))),!(c instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(c.length===0)return"";for(var f=0,_=0,b=0,C=c.length;b!==C&&c[b]===0;)b++,f++;for(var w=(C-b)*D+1>>>0,g=new Uint8Array(w);b!==C;){for(var m=c[b],v=0,y=w-1;(m!==0||v<_)&&y!==-1;y--,v++)m+=256*g[y]>>>0,g[y]=m%a>>>0,m=m/a>>>0;if(m!==0)throw new Error("Non-zero carry");_=v,b++}for(var A=w-_;A!==w&&g[A]===0;)A++;for(var S=o.repeat(f);A<w;++A)S+=t.charAt(g[A]);return S}function E(c){if(typeof c!="string")throw new TypeError("Expected String");if(c.length===0)return new Uint8Array;var f=0;if(c[f]!==" "){for(var _=0,b=0;c[f]===o;)_++,f++;for(var C=(c.length-f)*h+1>>>0,w=new Uint8Array(C);c[f];){var g=e[c.charCodeAt(f)];if(g===255)return;for(var m=0,v=C-1;(g!==0||m<b)&&v!==-1;v--,m++)g+=a*w[v]>>>0,w[v]=g%256>>>0,g=g/256>>>0;if(g!==0)throw new Error("Non-zero carry");b=m,f++}if(c[f]!==" "){for(var y=C-b;y!==C&&w[y]===0;)y++;for(var A=new Uint8Array(_+(C-y)),S=_;y!==C;)A[S++]=w[y++];return A}}}function l(c){var f=E(c);if(f)return f;throw new Error(`Non-${r} character`)}return{encode:p,decodeUnsafe:E,decode:l}}var Ve=Ke,ke=Ve;const te=t=>{if(t instanceof Uint8Array&&t.constructor.name==="Uint8Array")return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);throw new Error("Unknown type, must be binary type")},Xe=t=>new TextEncoder().encode(t),Je=t=>new TextDecoder().decode(t);class He{constructor(r,e,i){this.name=r,this.prefix=e,this.baseEncode=i}encode(r){if(r instanceof Uint8Array)return`${this.prefix}${this.baseEncode(r)}`;throw Error("Unknown type, must be binary type")}}class Ye{constructor(r,e,i){if(this.name=r,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=i}decode(r){if(typeof r=="string"){if(r.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(r)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(r.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(r){return re(this,r)}}class Ge{constructor(r){this.decoders=r}or(r){return re(this,r)}decode(r){const e=r[0],i=this.decoders[e];if(i)return i.decode(r);throw RangeError(`Unable to decode multibase string ${JSON.stringify(r)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const re=(t,r)=>new Ge({...t.decoders||{[t.prefix]:t},...r.decoders||{[r.prefix]:r}});class Qe{constructor(r,e,i,n){this.name=r,this.prefix=e,this.baseEncode=i,this.baseDecode=n,this.encoder=new He(r,e,i),this.decoder=new Ye(r,e,n)}encode(r){return this.encoder.encode(r)}decode(r){return this.decoder.decode(r)}}const B=({name:t,prefix:r,encode:e,decode:i})=>new Qe(t,r,e,i),O=({prefix:t,name:r,alphabet:e})=>{const{encode:i,decode:n}=ke(e,r);return B({prefix:t,name:r,encode:i,decode:s=>te(n(s))})},Ze=(t,r,e,i)=>{const n={};for(let D=0;D<r.length;++D)n[r[D]]=D;let s=t.length;for(;t[s-1]==="=";)--s;const u=new Uint8Array(s*e/8|0);let a=0,o=0,h=0;for(let D=0;D<s;++D){const p=n[t[D]];if(p===void 0)throw new SyntaxError(`Non-${i} character`);o=o<<e|p,a+=e,a>=8&&(a-=8,u[h++]=255&o>>a)}if(a>=e||255&o<<8-a)throw new SyntaxError("Unexpected end of data");return u},We=(t,r,e)=>{const i=r[r.length-1]==="=",n=(1<<e)-1;let s="",u=0,a=0;for(let o=0;o<t.length;++o)for(a=a<<8|t[o],u+=8;u>e;)u-=e,s+=r[n&a>>u];if(u&&(s+=r[n&a<<e-u]),i)for(;s.length*e&7;)s+="=";return s},d=({name:t,prefix:r,bitsPerChar:e,alphabet:i})=>B({prefix:r,name:t,encode(n){return We(n,i,e)},decode(n){return Ze(n,i,e,t)}}),et=B({prefix:"\0",name:"identity",encode:t=>Je(t),decode:t=>Xe(t)});var tt=Object.freeze({__proto__:null,identity:et});const rt=d({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var it=Object.freeze({__proto__:null,base2:rt});const nt=d({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var st=Object.freeze({__proto__:null,base8:nt});const ut=O({prefix:"9",name:"base10",alphabet:"0123456789"});var at=Object.freeze({__proto__:null,base10:ut});const ot=d({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Dt=d({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ct=Object.freeze({__proto__:null,base16:ot,base16upper:Dt});const ht=d({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),lt=d({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),dt=d({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),pt=d({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ft=d({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Et=d({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),gt=d({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),bt=d({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),yt=d({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Ct=Object.freeze({__proto__:null,base32:ht,base32upper:lt,base32pad:dt,base32padupper:pt,base32hex:ft,base32hexupper:Et,base32hexpad:gt,base32hexpadupper:bt,base32z:yt});const wt=O({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),mt=O({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var At=Object.freeze({__proto__:null,base36:wt,base36upper:mt});const vt=O({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),_t=O({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Rt=Object.freeze({__proto__:null,base58btc:vt,base58flickr:_t});const Tt=d({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),It=d({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),xt=d({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ft=d({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Ut=Object.freeze({__proto__:null,base64:Tt,base64pad:It,base64url:xt,base64urlpad:Ft});const ie=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Nt=ie.reduce((t,r,e)=>(t[e]=r,t),[]),Ot=ie.reduce((t,r,e)=>(t[r.codePointAt(0)]=e,t),[]);function St(t){return t.reduce((r,e)=>(r+=Nt[e],r),"")}function qt(t){const r=[];for(const e of t){const i=Ot[e.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${e}`);r.push(i)}return new Uint8Array(r)}const Pt=B({prefix:"\u{1F680}",name:"base256emoji",encode:St,decode:qt});var Bt=Object.freeze({__proto__:null,base256emoji:Pt}),$t=se,ne=128,Lt=127,Mt=~Lt,jt=Math.pow(2,31);function se(t,r,e){r=r||[],e=e||0;for(var i=e;t>=jt;)r[e++]=t&255|ne,t/=128;for(;t&Mt;)r[e++]=t&255|ne,t>>>=7;return r[e]=t|0,se.bytes=e-i+1,r}var zt=z,Kt=128,ue=127;function z(t,i){var e=0,i=i||0,n=0,s=i,u,a=t.length;do{if(s>=a)throw z.bytes=0,new RangeError("Could not decode varint");u=t[s++],e+=n<28?(u&ue)<<n:(u&ue)*Math.pow(2,n),n+=7}while(u>=Kt);return z.bytes=s-i,e}var Vt=Math.pow(2,7),kt=Math.pow(2,14),Xt=Math.pow(2,21),Jt=Math.pow(2,28),Ht=Math.pow(2,35),Yt=Math.pow(2,42),Gt=Math.pow(2,49),Qt=Math.pow(2,56),Zt=Math.pow(2,63),Wt=function(t){return t<Vt?1:t<kt?2:t<Xt?3:t<Jt?4:t<Ht?5:t<Yt?6:t<Gt?7:t<Qt?8:t<Zt?9:10},er={encode:$t,decode:zt,encodingLength:Wt},ae=er;const oe=(t,r,e=0)=>(ae.encode(t,r,e),r),De=t=>ae.encodingLength(t),K=(t,r)=>{const e=r.byteLength,i=De(t),n=i+De(e),s=new Uint8Array(n+e);return oe(t,s,0),oe(e,s,i),s.set(r,n),new tr(t,e,r,s)};class tr{constructor(r,e,i,n){this.code=r,this.size=e,this.digest=i,this.bytes=n}}const ce=({name:t,code:r,encode:e})=>new rr(t,r,e);class rr{constructor(r,e,i){this.name=r,this.code=e,this.encode=i}digest(r){if(r instanceof Uint8Array){const e=this.encode(r);return e instanceof Uint8Array?K(this.code,e):e.then(i=>K(this.code,i))}else throw Error("Unknown type, must be binary type")}}const he=t=>async r=>new Uint8Array(await crypto.subtle.digest(t,r)),ir=ce({name:"sha2-256",code:18,encode:he("SHA-256")}),nr=ce({name:"sha2-512",code:19,encode:he("SHA-512")});var sr=Object.freeze({__proto__:null,sha256:ir,sha512:nr});const le=0,ur="identity",de=te,ar=t=>K(le,de(t)),or={code:le,name:ur,encode:de,digest:ar};var Dr=Object.freeze({__proto__:null,identity:or});new TextEncoder,new TextDecoder;const pe={...tt,...it,...st,...at,...ct,...Ct,...At,...Rt,...Ut,...Bt};({...sr,...Dr});function fe(t,r,e,i){return{name:t,prefix:r,encoder:{name:t,prefix:r,encode:e},decoder:{decode:i}}}const Ee=fe("utf8","u",t=>"u"+new TextDecoder("utf8").decode(t),t=>new TextEncoder().encode(t.substring(1))),V=fe("ascii","a",t=>{let r="a";for(let e=0;e<t.length;e++)r+=String.fromCharCode(t[e]);return r},t=>{t=t.substring(1);const r=ze(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}),ge={utf8:Ee,"utf-8":Ee,hex:pe.base16,latin1:V,ascii:V,binary:V,...pe};function cr(t,r="utf8"){const e=ge[r];if(!e)throw new Error(`Unsupported encoding "${r}"`);return(r==="utf8"||r==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(t,"utf8"):e.decoder.decode(`${e.prefix}${t}`)}function hr(t,r="utf8"){const e=ge[r];if(!e)throw new Error(`Unsupported encoding "${r}"`);return(r==="utf8"||r==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString("utf8"):e.encoder.encode(t).substring(1)}const lr="base10",be="base16",dr="base64pad",ye="utf8";function pr(){return Re.randomStringForEntropy(96)}function Ce(t){const r=Te.hash(cr(t,ye));return hr(r,be)}var fr=Object.defineProperty,Er=Object.defineProperties,gr=Object.getOwnPropertyDescriptors,we=Object.getOwnPropertySymbols,br=Object.prototype.hasOwnProperty,yr=Object.prototype.propertyIsEnumerable,me=(t,r,e)=>r in t?fr(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,k=(t,r)=>{for(var e in r||(r={}))br.call(r,e)&&me(t,e,r[e]);if(we)for(var e of we(r))yr.call(r,e)&&me(t,e,r[e]);return t},Cr=(t,r)=>Er(t,gr(r));class wr extends J{constructor(r){super(r),this.initialized=!1,this.name="authEngine",this.init=()=>{this.initialized||(this.registerRelayerEvents(),this.client.core.pairing.register({methods:Object.keys(U)}),this.initialized=!0)},this.request=async(e,i)=>{if(this.isInitialized(),!Me(e))throw new Error("Invalid request");if(i!=null&&i.topic)return await this.requestOnKnownPairing(i.topic,e);const{chainId:n,statement:s,aud:u,domain:a,nonce:o,type:h}=e,{topic:D,uri:p}=await this.client.core.pairing.create();this.client.logger.info({message:"Generated new pairing",pairing:{topic:D,uri:p}});const E=await this.client.core.crypto.generateKeyPair(),l=T.hashKey(E);await this.client.authKeys.set(I,{responseTopic:l,publicKey:E}),await this.client.pairingTopics.set(l,{topic:l,pairingTopic:D}),await this.client.core.relayer.subscribe(l),this.client.logger.info(`sending request to new pairing topic: ${D}`);const c=await this.sendRequest(D,"wc_authRequest",{payloadParams:{type:h??"eip4361",chainId:n,statement:s,aud:u,domain:a,version:"1",nonce:o,iat:new Date().toISOString()},requester:{publicKey:E,metadata:this.client.metadata}},{},e.expiry);return this.client.logger.info(`sent request to new pairing topic: ${D}`),{uri:p,id:c}},this.respond=async(e,i)=>{if(this.isInitialized(),!je(e,this.client.requests))throw new Error("Invalid response");const n=ee(this.client.requests,e.id),s=n.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),a=T.hashKey(s),o={type:T.TYPE_1,receiverPublicKey:s,senderPublicKey:u};if("error"in e){await this.sendError(n.id,a,e,o);return}const h={h:{t:"eip4361"},p:Cr(k({},n.cacaoPayload),{iss:i}),s:e.signature},D=await this.sendResult(n.id,a,h,o);await this.client.requests.update(D,k({},h))},this.getPendingRequests=()=>W(this.client.requests),this.formatMessage=(e,i)=>{this.client.logger.debug(`formatMessage, cacao is: ${JSON.stringify(e)}`);const n=`${e.domain} wants you to sign in with your Ethereum account:`,s=Z(i),u=e.statement,a=`URI: ${e.aud}`,o=`Version: ${e.version}`,h=`Chain ID: ${Se(i)}`,D=`Nonce: ${e.nonce}`,p=`Issued At: ${e.iat}`,E=e.resources&&e.resources.length>0?`Resources:
${e.resources.map(l=>`- ${l}`).join(`
`)}`:void 0;return[n,s,"",u,"",a,o,h,D,p,E].filter(l=>l!=null).join(`
`)},this.setExpiry=async(e,i)=>{this.client.core.pairing.pairings.keys.includes(e)&&await this.client.core.pairing.updateExpiry({topic:e,expiry:i}),this.client.core.expirer.set(e,i)},this.sendRequest=async(e,i,n,s,u)=>{const a=R.formatJsonRpcRequest(i,n),o=await this.client.core.crypto.encode(e,a,s),h=U[i].req;return u&&(h.ttl=u),this.client.core.history.set(e,a),await this.client.core.relayer.publish(e,o,h),a.id},this.sendResult=async(e,i,n,s)=>{const u=R.formatJsonRpcResult(e,n),a=await this.client.core.crypto.encode(i,u,s),o=await this.client.core.history.get(i,e),h=U[o.request.method].res;return await this.client.core.relayer.publish(i,a,h),await this.client.core.history.resolve(u),u.id},this.sendError=async(e,i,n,s)=>{const u=R.formatJsonRpcError(e,n.error),a=await this.client.core.crypto.encode(i,u,s),o=await this.client.core.history.get(i,e),h=U[o.request.method].res;return await this.client.core.relayer.publish(i,a,h),await this.client.core.history.resolve(u),u.id},this.requestOnKnownPairing=async(e,i)=>{const n=this.client.core.pairing.pairings.getAll({active:!0}).find(l=>l.topic===e);if(!n)throw new Error(`Could not find pairing for provided topic ${e}`);const{publicKey:s}=this.client.authKeys.get(I),{chainId:u,statement:a,aud:o,domain:h,nonce:D,type:p}=i,E=await this.sendRequest(n.topic,"wc_authRequest",{payloadParams:{type:p??"eip4361",chainId:u,statement:a,aud:o,domain:h,version:"1",nonce:D,iat:new Date().toISOString()},requester:{publicKey:s,metadata:this.client.metadata}},{},i.expiry);return this.client.logger.info(`sent request to known pairing topic: ${n.topic}`),{id:E}},this.onRelayEventRequest=e=>{const{topic:i,payload:n}=e,s=n.method;switch(s){case"wc_authRequest":return this.onAuthRequest(i,n);default:return this.client.logger.info(`Unsupported request method ${s}`)}},this.onRelayEventResponse=async e=>{const{topic:i,payload:n}=e,s=(await this.client.core.history.get(i,n.id)).request.method;switch(s){case"wc_authRequest":return this.onAuthResponse(i,n);default:return this.client.logger.info(`Unsupported response method ${s}`)}},this.onAuthRequest=async(e,i)=>{const{requester:n,payloadParams:{resources:s,statement:u,aud:a,domain:o,version:h,nonce:D,iat:p,chainId:E}}=i.params;this.client.logger.info({type:"onAuthRequest",topic:e,payload:i});try{const l={aud:a,domain:o,version:h,nonce:D,iat:p,statement:u,resources:s,chainId:E};await this.client.requests.set(i.id,{requester:n,pairingTopic:e,id:i.id,cacaoPayload:l});const c=Ce(JSON.stringify(i)),f=await this.getVerifyContext(c,this.client.metadata);this.client.emit("auth_request",{id:i.id,topic:e,params:{requester:n,cacaoPayload:l},verifyContext:f})}catch(l){await this.sendError(i.id,e,l),this.client.logger.error(l)}},this.onAuthResponse=async(e,i)=>{const{id:n}=i;if(this.client.logger.info({type:"onAuthResponse",topic:e,response:i}),R.isJsonRpcResult(i)){const{pairingTopic:s}=this.client.pairingTopics.get(e);await this.client.core.pairing.activate({topic:s});const{s:u,p:a}=i.result;await this.client.requests.set(n,k({id:n,pairingTopic:s},i.result));const o=this.formatMessage(a,a.iss);this.client.logger.debug(`reconstructed message:
`,JSON.stringify(o)),this.client.logger.debug("payload.iss:",a.iss),this.client.logger.debug("signature:",u);const h=Z(a.iss),D=qe(a.iss);if(!h)throw new Error("Could not derive address from `payload.iss`");if(!D)throw new Error("Could not derive chainId from `payload.iss`");this.client.logger.debug("walletAddress extracted from `payload.iss`:",h),await Pe(h,o,u,D,this.client.projectId)?this.client.emit("auth_response",{id:n,topic:e,params:i}):this.client.emit("auth_response",{id:n,topic:e,params:{message:"Invalid signature",code:-1}})}else R.isJsonRpcError(i)&&this.client.emit("auth_response",{id:n,topic:e,params:i})},this.getVerifyContext=async(e,i)=>{const n={verified:{verifyUrl:i.verifyUrl||"",validation:"UNKNOWN",origin:i.url||""}};try{const s=await this.client.core.verify.resolve({attestationId:e,verifyUrl:i.verifyUrl});s&&(n.verified.origin=s,n.verified.validation=s===i.url?"VALID":"INVALID")}catch(s){this.client.logger.error(s)}return this.client.logger.info(`Verify context: ${JSON.stringify(n)}`),n}}isInitialized(){if(!this.initialized){const{message:r}=T.getInternalError("NOT_INITIALIZED",this.name);throw new Error(r)}}registerRelayerEvents(){this.client.core.relayer.on(x.RELAYER_EVENTS.message,async r=>{const{topic:e,message:i}=r,{responseTopic:n,publicKey:s}=this.client.authKeys.keys.includes(I)?this.client.authKeys.get(I):{responseTopic:void 0,publicKey:void 0};if(n&&e!==n){this.client.logger.debug("[Auth] Ignoring message from unknown topic",e);return}const u=await this.client.core.crypto.decode(e,i,{receiverPublicKey:s});R.isJsonRpcRequest(u)?(this.client.core.history.set(e,u),this.onRelayEventRequest({topic:e,payload:u})):R.isJsonRpcResponse(u)&&(await this.client.core.history.resolve(u),this.onRelayEventResponse({topic:e,payload:u}))})}}class $ extends H{constructor(r){super(r),this.protocol=L,this.version=G,this.name=M,this.events=new Ae.EventEmitter,this.emit=(i,n)=>this.events.emit(i,n),this.on=(i,n)=>this.events.on(i,n),this.once=(i,n)=>this.events.once(i,n),this.off=(i,n)=>this.events.off(i,n),this.removeListener=(i,n)=>this.events.removeListener(i,n),this.request=async(i,n)=>{try{return await this.engine.request(i,n)}catch(s){throw this.logger.error(s.message),s}},this.respond=async(i,n)=>{try{return await this.engine.respond(i,n)}catch(s){throw this.logger.error(s.message),s}},this.getPendingRequests=()=>{try{return this.engine.getPendingRequests()}catch(i){throw this.logger.error(i.message),i}},this.formatMessage=(i,n)=>{try{return this.engine.formatMessage(i,n)}catch(s){throw this.logger.error(s.message),s}};const e=typeof r.logger<"u"&&typeof r.logger!="string"?r.logger:q.pino(q.getDefaultLoggerOptions({level:r.logger||"error"}));this.name=r?.name||M,this.metadata=r.metadata,this.projectId=r.projectId,this.core=r.core||new x.Core(r),this.logger=q.generateChildLogger(e,this.name),this.authKeys=new x.Store(this.core,this.logger,"authKeys",N,()=>I),this.pairingTopics=new x.Store(this.core,this.logger,"pairingTopics",N),this.requests=new x.Store(this.core,this.logger,"requests",N),this.engine=new wr(this)}static async init(r){const e=new $(r);return await e.initialize(),e}get context(){return q.getLoggerContext(this.logger)}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.authKeys.init(),await this.requests.init(),await this.pairingTopics.init(),await this.engine.init(),this.logger.info("AuthClient Initialization Success"),this.logger.info({authClient:this})}catch(r){throw this.logger.info("AuthClient Initialization Failure"),this.logger.error(r.message),r}}}const mr=$;exports.AUTH_CLIENT_CONTEXT=Q,exports.AUTH_CLIENT_DEFAULT_NAME=M,exports.AUTH_CLIENT_PROTOCOL=L,exports.AUTH_CLIENT_PUBLIC_KEY_NAME=I,exports.AUTH_CLIENT_STORAGE_PREFIX=N,exports.AUTH_CLIENT_VERSION=G,exports.AUTH_REQUEST_EXPIRY_BOUNDARIES=P,exports.AuthClient=mr,exports.BASE10=lr,exports.BASE16=be,exports.BASE64=dr,exports.DEFAULT_RPC_URL=Y,exports.ENGINE_RPC_OPTS=U,exports.EXPIRER_CONTEXT=Fe,exports.EXPIRER_DEFAULT_TTL=Oe,exports.EXPIRER_EVENTS=Ue,exports.EXPIRER_STORAGE_VERSION=Ne,exports.IAuthClient=H,exports.IAuthEngine=J,exports.UTF8=ye,exports.default=$,exports.generateNonce=pr,exports.hashMessage=Ce;
//# sourceMappingURL=index.cjs.js.map
