import{RELAYER_EVENTS as me,Core as ve,Store as q}from"@walletconnect/core";import{pino as Ae,getDefaultLoggerOptions as _e,generateChildLogger as xe,getLoggerContext as Re}from"@walletconnect/logger";import{EventEmitter as Fe}from"events";import{formatJsonRpcRequest as Te,formatJsonRpcResult as Ie,formatJsonRpcError as Ue,isJsonRpcResult as Se,isJsonRpcError as Oe,isJsonRpcRequest as qe,isJsonRpcResponse as $e}from"@walletconnect/jsonrpc-utils";import{isValidUrl as Be,isValidRequestExpiry as Ne,getInternalError as K,hashKey as V,TYPE_1 as Pe}from"@walletconnect/utils";import{ONE_DAY as $,FIVE_MINUTES as ze,SEVEN_DAYS as Me}from"@walletconnect/time";import{hashMessage as k}from"@ethersproject/hash";import{recoverAddress as je}from"@ethersproject/transactions";import Le from"isomorphic-unfetch";import{randomStringForEntropy as Ke}from"@stablelib/random";import{hash as Ve}from"@stablelib/sha256";class J{constructor(t){this.client=t}}class X{constructor(t){this.opts=t}}const G="https://rpc.walletconnect.com/v1",R={wc_authRequest:{req:{ttl:$,prompt:!0,tag:3e3},res:{ttl:$,prompt:!1,tag:3001}}},U={min:ze,max:Me},B="wc",H=1,Y="auth",N="authClient",F=`${B}@${1}:${Y}:`,x=`${F}:PUB_KEY`,ke="expirer",Je={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Xe="0.3",Ge=$;function P(r){return r?.split(":")}function He(r){const t=r&&P(r);if(t)return t[3]}function Ye(r){const t=r&&P(r);if(t)return t[2]+":"+t[3]}function Q(r){const t=r&&P(r);if(t)return t.pop()}async function Qe(r,t,e,i,n){switch(e.t){case"eip191":return Ze(r,t,e.s);case"eip1271":return await We(r,t,e.s,i,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${e.t}`)}}function Ze(r,t,e){return je(k(t),e).toLowerCase()===r.toLowerCase()}async function We(r,t,e,i,n){try{const s="0x1626ba7e",u="0000000000000000000000000000000000000000000000000000000000000040",o="0000000000000000000000000000000000000000000000000000000000000041",a=e.substring(2),h=k(t).substring(2),D=s+h+u+o+a,p=await Le(`${G}/?chainId=${i}&projectId=${n}`,{method:"POST",body:JSON.stringify({id:et(),jsonrpc:"2.0",method:"eth_call",params:[{to:r,data:D},"latest"]})}),{result:g}=await p.json();return g?g.slice(0,s.length).toLowerCase()===s.toLowerCase():!1}catch(s){return console.error("isValidEip1271Signature: ",s),!1}}function et(){return Date.now()+Math.floor(Math.random()*1e3)}function Z(r){return r.getAll().filter(t=>"requester"in t)}function W(r,t){return Z(r).find(e=>e.id===t)}function tt(r){const t=Be(r.aud),e=new RegExp(`${r.domain}`).test(r.aud),i=!!r.nonce,n=r.type?r.type==="eip4361":!0,s=r.expiry;if(s&&!Ne(s,U)){const{message:u}=K("MISSING_OR_INVALID",`request() expiry: ${s}. Expiry must be a number (in seconds) between ${U.min} and ${U.max}`);throw new Error(u)}return!!(t&&e&&i&&n)}function rt(r,t){return!!W(t,r.id)}function it(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}function nt(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),i=0;i<e.length;i++)e[i]=255;for(var n=0;n<r.length;n++){var s=r.charAt(n),u=s.charCodeAt(0);if(e[u]!==255)throw new TypeError(s+" is ambiguous");e[u]=n}var o=r.length,a=r.charAt(0),h=Math.log(o)/Math.log(256),D=Math.log(256)/Math.log(o);function p(c){if(c instanceof Uint8Array||(ArrayBuffer.isView(c)?c=new Uint8Array(c.buffer,c.byteOffset,c.byteLength):Array.isArray(c)&&(c=Uint8Array.from(c))),!(c instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(c.length===0)return"";for(var f=0,_=0,b=0,w=c.length;b!==w&&c[b]===0;)b++,f++;for(var C=(w-b)*D+1>>>0,E=new Uint8Array(C);b!==w;){for(var m=c[b],A=0,y=C-1;(m!==0||A<_)&&y!==-1;y--,A++)m+=256*E[y]>>>0,E[y]=m%o>>>0,m=m/o>>>0;if(m!==0)throw new Error("Non-zero carry");_=A,b++}for(var v=C-_;v!==C&&E[v]===0;)v++;for(var I=a.repeat(f);v<C;++v)I+=r.charAt(E[v]);return I}function g(c){if(typeof c!="string")throw new TypeError("Expected String");if(c.length===0)return new Uint8Array;var f=0;if(c[f]!==" "){for(var _=0,b=0;c[f]===a;)_++,f++;for(var w=(c.length-f)*h+1>>>0,C=new Uint8Array(w);c[f];){var E=e[c.charCodeAt(f)];if(E===255)return;for(var m=0,A=w-1;(E!==0||m<b)&&A!==-1;A--,m++)E+=o*C[A]>>>0,C[A]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");b=m,f++}if(c[f]!==" "){for(var y=w-b;y!==w&&C[y]===0;)y++;for(var v=new Uint8Array(_+(w-y)),I=_;y!==w;)v[I++]=C[y++];return v}}}function l(c){var f=g(c);if(f)return f;throw new Error(`Non-${t} character`)}return{encode:p,decodeUnsafe:g,decode:l}}var st=nt,ut=st;const ee=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},ot=r=>new TextEncoder().encode(r),at=r=>new TextDecoder().decode(r);class Dt{constructor(t,e,i){this.name=t,this.prefix=e,this.baseEncode=i}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}class ct{constructor(t,e,i){if(this.name=t,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=i}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return te(this,t)}}class ht{constructor(t){this.decoders=t}or(t){return te(this,t)}decode(t){const e=t[0],i=this.decoders[e];if(i)return i.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const te=(r,t)=>new ht({...r.decoders||{[r.prefix]:r},...t.decoders||{[t.prefix]:t}});class lt{constructor(t,e,i,n){this.name=t,this.prefix=e,this.baseEncode=i,this.baseDecode=n,this.encoder=new Dt(t,e,i),this.decoder=new ct(t,e,n)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}const S=({name:r,prefix:t,encode:e,decode:i})=>new lt(r,t,e,i),T=({prefix:r,name:t,alphabet:e})=>{const{encode:i,decode:n}=ut(e,t);return S({prefix:r,name:t,encode:i,decode:s=>ee(n(s))})},dt=(r,t,e,i)=>{const n={};for(let D=0;D<t.length;++D)n[t[D]]=D;let s=r.length;for(;r[s-1]==="=";)--s;const u=new Uint8Array(s*e/8|0);let o=0,a=0,h=0;for(let D=0;D<s;++D){const p=n[r[D]];if(p===void 0)throw new SyntaxError(`Non-${i} character`);a=a<<e|p,o+=e,o>=8&&(o-=8,u[h++]=255&a>>o)}if(o>=e||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return u},pt=(r,t,e)=>{const i=t[t.length-1]==="=",n=(1<<e)-1;let s="",u=0,o=0;for(let a=0;a<r.length;++a)for(o=o<<8|r[a],u+=8;u>e;)u-=e,s+=t[n&o>>u];if(u&&(s+=t[n&o<<e-u]),i)for(;s.length*e&7;)s+="=";return s},d=({name:r,prefix:t,bitsPerChar:e,alphabet:i})=>S({prefix:t,name:r,encode(n){return pt(n,i,e)},decode(n){return dt(n,i,e,r)}}),ft=S({prefix:"\0",name:"identity",encode:r=>at(r),decode:r=>ot(r)});var gt=Object.freeze({__proto__:null,identity:ft});const Et=d({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var bt=Object.freeze({__proto__:null,base2:Et});const yt=d({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var wt=Object.freeze({__proto__:null,base8:yt});const Ct=T({prefix:"9",name:"base10",alphabet:"0123456789"});var mt=Object.freeze({__proto__:null,base10:Ct});const vt=d({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),At=d({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var _t=Object.freeze({__proto__:null,base16:vt,base16upper:At});const xt=d({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Rt=d({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Ft=d({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Tt=d({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),It=d({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ut=d({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),St=d({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ot=d({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),qt=d({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var $t=Object.freeze({__proto__:null,base32:xt,base32upper:Rt,base32pad:Ft,base32padupper:Tt,base32hex:It,base32hexupper:Ut,base32hexpad:St,base32hexpadupper:Ot,base32z:qt});const Bt=T({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Nt=T({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Pt=Object.freeze({__proto__:null,base36:Bt,base36upper:Nt});const zt=T({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Mt=T({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var jt=Object.freeze({__proto__:null,base58btc:zt,base58flickr:Mt});const Lt=d({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Kt=d({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Vt=d({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),kt=d({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Jt=Object.freeze({__proto__:null,base64:Lt,base64pad:Kt,base64url:Vt,base64urlpad:kt});const re=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Xt=re.reduce((r,t,e)=>(r[e]=t,r),[]),Gt=re.reduce((r,t,e)=>(r[t.codePointAt(0)]=e,r),[]);function Ht(r){return r.reduce((t,e)=>(t+=Xt[e],t),"")}function Yt(r){const t=[];for(const e of r){const i=Gt[e.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${e}`);t.push(i)}return new Uint8Array(t)}const Qt=S({prefix:"\u{1F680}",name:"base256emoji",encode:Ht,decode:Yt});var Zt=Object.freeze({__proto__:null,base256emoji:Qt}),Wt=ne,ie=128,er=127,tr=~er,rr=Math.pow(2,31);function ne(r,t,e){t=t||[],e=e||0;for(var i=e;r>=rr;)t[e++]=r&255|ie,r/=128;for(;r&tr;)t[e++]=r&255|ie,r>>>=7;return t[e]=r|0,ne.bytes=e-i+1,t}var ir=z,nr=128,se=127;function z(r,i){var e=0,i=i||0,n=0,s=i,u,o=r.length;do{if(s>=o)throw z.bytes=0,new RangeError("Could not decode varint");u=r[s++],e+=n<28?(u&se)<<n:(u&se)*Math.pow(2,n),n+=7}while(u>=nr);return z.bytes=s-i,e}var sr=Math.pow(2,7),ur=Math.pow(2,14),or=Math.pow(2,21),ar=Math.pow(2,28),Dr=Math.pow(2,35),cr=Math.pow(2,42),hr=Math.pow(2,49),lr=Math.pow(2,56),dr=Math.pow(2,63),pr=function(r){return r<sr?1:r<ur?2:r<or?3:r<ar?4:r<Dr?5:r<cr?6:r<hr?7:r<lr?8:r<dr?9:10},fr={encode:Wt,decode:ir,encodingLength:pr},ue=fr;const oe=(r,t,e=0)=>(ue.encode(r,t,e),t),ae=r=>ue.encodingLength(r),M=(r,t)=>{const e=t.byteLength,i=ae(r),n=i+ae(e),s=new Uint8Array(n+e);return oe(r,s,0),oe(e,s,i),s.set(t,n),new gr(r,e,t,s)};class gr{constructor(t,e,i,n){this.code=t,this.size=e,this.digest=i,this.bytes=n}}const De=({name:r,code:t,encode:e})=>new Er(r,t,e);class Er{constructor(t,e,i){this.name=t,this.code=e,this.encode=i}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?M(this.code,e):e.then(i=>M(this.code,i))}else throw Error("Unknown type, must be binary type")}}const ce=r=>async t=>new Uint8Array(await crypto.subtle.digest(r,t)),br=De({name:"sha2-256",code:18,encode:ce("SHA-256")}),yr=De({name:"sha2-512",code:19,encode:ce("SHA-512")});var wr=Object.freeze({__proto__:null,sha256:br,sha512:yr});const he=0,Cr="identity",le=ee,mr=r=>M(he,le(r)),vr={code:he,name:Cr,encode:le,digest:mr};var Ar=Object.freeze({__proto__:null,identity:vr});new TextEncoder,new TextDecoder;const de={...gt,...bt,...wt,...mt,..._t,...$t,...Pt,...jt,...Jt,...Zt};({...wr,...Ar});function pe(r,t,e,i){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:i}}}const fe=pe("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),j=pe("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);const t=it(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),ge={utf8:fe,"utf-8":fe,hex:de.base16,latin1:j,ascii:j,binary:j,...de};function _r(r,t="utf8"){const e=ge[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r,"utf8"):e.decoder.decode(`${e.prefix}${r}`)}function xr(r,t="utf8"){const e=ge[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):e.encoder.encode(r).substring(1)}const Rr="base10",Ee="base16",Fr="base64pad",be="utf8";function Tr(){return Ke(96)}function ye(r){const t=Ve(_r(r,be));return xr(t,Ee)}var Ir=Object.defineProperty,Ur=Object.defineProperties,Sr=Object.getOwnPropertyDescriptors,we=Object.getOwnPropertySymbols,Or=Object.prototype.hasOwnProperty,qr=Object.prototype.propertyIsEnumerable,Ce=(r,t,e)=>t in r?Ir(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,L=(r,t)=>{for(var e in t||(t={}))Or.call(t,e)&&Ce(r,e,t[e]);if(we)for(var e of we(t))qr.call(t,e)&&Ce(r,e,t[e]);return r},$r=(r,t)=>Ur(r,Sr(t));class Br extends J{constructor(t){super(t),this.initialized=!1,this.name="authEngine",this.init=()=>{this.initialized||(this.registerRelayerEvents(),this.client.core.pairing.register({methods:Object.keys(R)}),this.initialized=!0)},this.request=async(e,i)=>{if(this.isInitialized(),!tt(e))throw new Error("Invalid request");if(i!=null&&i.topic)return await this.requestOnKnownPairing(i.topic,e);const{chainId:n,statement:s,aud:u,domain:o,nonce:a,type:h}=e,{topic:D,uri:p}=await this.client.core.pairing.create();this.client.logger.info({message:"Generated new pairing",pairing:{topic:D,uri:p}});const g=await this.client.core.crypto.generateKeyPair(),l=V(g);await this.client.authKeys.set(x,{responseTopic:l,publicKey:g}),await this.client.pairingTopics.set(l,{topic:l,pairingTopic:D}),await this.client.core.relayer.subscribe(l),this.client.logger.info(`sending request to new pairing topic: ${D}`);const c=await this.sendRequest(D,"wc_authRequest",{payloadParams:{type:h??"eip4361",chainId:n,statement:s,aud:u,domain:o,version:"1",nonce:a,iat:new Date().toISOString()},requester:{publicKey:g,metadata:this.client.metadata}},{},e.expiry);return this.client.logger.info(`sent request to new pairing topic: ${D}`),{uri:p,id:c}},this.respond=async(e,i)=>{if(this.isInitialized(),!rt(e,this.client.requests))throw new Error("Invalid response");const n=W(this.client.requests,e.id),s=n.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),o=V(s),a={type:Pe,receiverPublicKey:s,senderPublicKey:u};if("error"in e){await this.sendError(n.id,o,e,a);return}const h={h:{t:"eip4361"},p:$r(L({},n.cacaoPayload),{iss:i}),s:e.signature},D=await this.sendResult(n.id,o,h,a);await this.client.requests.update(D,L({},h))},this.getPendingRequests=()=>Z(this.client.requests),this.formatMessage=(e,i)=>{this.client.logger.debug(`formatMessage, cacao is: ${JSON.stringify(e)}`);const n=`${e.domain} wants you to sign in with your Ethereum account:`,s=Q(i),u=e.statement,o=`URI: ${e.aud}`,a=`Version: ${e.version}`,h=`Chain ID: ${He(i)}`,D=`Nonce: ${e.nonce}`,p=`Issued At: ${e.iat}`,g=e.resources&&e.resources.length>0?`Resources:
${e.resources.map(l=>`- ${l}`).join(`
`)}`:void 0;return[n,s,"",u,"",o,a,h,D,p,g].filter(l=>l!=null).join(`
`)},this.setExpiry=async(e,i)=>{this.client.core.pairing.pairings.keys.includes(e)&&await this.client.core.pairing.updateExpiry({topic:e,expiry:i}),this.client.core.expirer.set(e,i)},this.sendRequest=async(e,i,n,s,u)=>{const o=Te(i,n),a=await this.client.core.crypto.encode(e,o,s),h=R[i].req;return u&&(h.ttl=u),this.client.core.history.set(e,o),await this.client.core.relayer.publish(e,a,h),o.id},this.sendResult=async(e,i,n,s)=>{const u=Ie(e,n),o=await this.client.core.crypto.encode(i,u,s),a=await this.client.core.history.get(i,e),h=R[a.request.method].res;return await this.client.core.relayer.publish(i,o,h),await this.client.core.history.resolve(u),u.id},this.sendError=async(e,i,n,s)=>{const u=Ue(e,n.error),o=await this.client.core.crypto.encode(i,u,s),a=await this.client.core.history.get(i,e),h=R[a.request.method].res;return await this.client.core.relayer.publish(i,o,h),await this.client.core.history.resolve(u),u.id},this.requestOnKnownPairing=async(e,i)=>{const n=this.client.core.pairing.pairings.getAll({active:!0}).find(l=>l.topic===e);if(!n)throw new Error(`Could not find pairing for provided topic ${e}`);const{publicKey:s}=this.client.authKeys.get(x),{chainId:u,statement:o,aud:a,domain:h,nonce:D,type:p}=i,g=await this.sendRequest(n.topic,"wc_authRequest",{payloadParams:{type:p??"eip4361",chainId:u,statement:o,aud:a,domain:h,version:"1",nonce:D,iat:new Date().toISOString()},requester:{publicKey:s,metadata:this.client.metadata}},{},i.expiry);return this.client.logger.info(`sent request to known pairing topic: ${n.topic}`),{id:g}},this.onRelayEventRequest=e=>{const{topic:i,payload:n}=e,s=n.method;switch(s){case"wc_authRequest":return this.onAuthRequest(i,n);default:return this.client.logger.info(`Unsupported request method ${s}`)}},this.onRelayEventResponse=async e=>{const{topic:i,payload:n}=e,s=(await this.client.core.history.get(i,n.id)).request.method;switch(s){case"wc_authRequest":return this.onAuthResponse(i,n);default:return this.client.logger.info(`Unsupported response method ${s}`)}},this.onAuthRequest=async(e,i)=>{const{requester:n,payloadParams:{resources:s,statement:u,aud:o,domain:a,version:h,nonce:D,iat:p,chainId:g}}=i.params;this.client.logger.info({type:"onAuthRequest",topic:e,payload:i});try{const l={aud:o,domain:a,version:h,nonce:D,iat:p,statement:u,resources:s,chainId:g};await this.client.requests.set(i.id,{requester:n,pairingTopic:e,id:i.id,cacaoPayload:l});const c=ye(JSON.stringify(i)),f=await this.getVerifyContext(c,this.client.metadata);this.client.emit("auth_request",{id:i.id,topic:e,params:{requester:n,cacaoPayload:l},verifyContext:f})}catch(l){await this.sendError(i.id,e,l),this.client.logger.error(l)}},this.onAuthResponse=async(e,i)=>{const{id:n}=i;if(this.client.logger.info({type:"onAuthResponse",topic:e,response:i}),Se(i)){const{pairingTopic:s}=this.client.pairingTopics.get(e);await this.client.core.pairing.activate({topic:s});const{s:u,p:o}=i.result;await this.client.requests.set(n,L({id:n,pairingTopic:s},i.result));const a=this.formatMessage(o,o.iss);this.client.logger.debug(`reconstructed message:
`,JSON.stringify(a)),this.client.logger.debug("payload.iss:",o.iss),this.client.logger.debug("signature:",u);const h=Q(o.iss),D=Ye(o.iss);if(!h)throw new Error("Could not derive address from `payload.iss`");if(!D)throw new Error("Could not derive chainId from `payload.iss`");this.client.logger.debug("walletAddress extracted from `payload.iss`:",h),await Qe(h,a,u,D,this.client.projectId)?this.client.emit("auth_response",{id:n,topic:e,params:i}):this.client.emit("auth_response",{id:n,topic:e,params:{message:"Invalid signature",code:-1}})}else Oe(i)&&this.client.emit("auth_response",{id:n,topic:e,params:i})},this.getVerifyContext=async(e,i)=>{const n={verified:{verifyUrl:i.verifyUrl||"",validation:"UNKNOWN",origin:i.url||""}};try{const s=await this.client.core.verify.resolve({attestationId:e,verifyUrl:i.verifyUrl});s&&(n.verified.origin=s,n.verified.validation=s===i.url?"VALID":"INVALID")}catch(s){this.client.logger.error(s)}return this.client.logger.info(`Verify context: ${JSON.stringify(n)}`),n}}isInitialized(){if(!this.initialized){const{message:t}=K("NOT_INITIALIZED",this.name);throw new Error(t)}}registerRelayerEvents(){this.client.core.relayer.on(me.message,async t=>{const{topic:e,message:i}=t,{responseTopic:n,publicKey:s}=this.client.authKeys.keys.includes(x)?this.client.authKeys.get(x):{responseTopic:void 0,publicKey:void 0};if(n&&e!==n){this.client.logger.debug("[Auth] Ignoring message from unknown topic",e);return}const u=await this.client.core.crypto.decode(e,i,{receiverPublicKey:s});qe(u)?(this.client.core.history.set(e,u),this.onRelayEventRequest({topic:e,payload:u})):$e(u)&&(await this.client.core.history.resolve(u),this.onRelayEventResponse({topic:e,payload:u}))})}}class O extends X{constructor(t){super(t),this.protocol=B,this.version=H,this.name=N,this.events=new Fe,this.emit=(i,n)=>this.events.emit(i,n),this.on=(i,n)=>this.events.on(i,n),this.once=(i,n)=>this.events.once(i,n),this.off=(i,n)=>this.events.off(i,n),this.removeListener=(i,n)=>this.events.removeListener(i,n),this.request=async(i,n)=>{try{return await this.engine.request(i,n)}catch(s){throw this.logger.error(s.message),s}},this.respond=async(i,n)=>{try{return await this.engine.respond(i,n)}catch(s){throw this.logger.error(s.message),s}},this.getPendingRequests=()=>{try{return this.engine.getPendingRequests()}catch(i){throw this.logger.error(i.message),i}},this.formatMessage=(i,n)=>{try{return this.engine.formatMessage(i,n)}catch(s){throw this.logger.error(s.message),s}};const e=typeof t.logger<"u"&&typeof t.logger!="string"?t.logger:Ae(_e({level:t.logger||"error"}));this.name=t?.name||N,this.metadata=t.metadata,this.projectId=t.projectId,this.core=t.core||new ve(t),this.logger=xe(e,this.name),this.authKeys=new q(this.core,this.logger,"authKeys",F,()=>x),this.pairingTopics=new q(this.core,this.logger,"pairingTopics",F),this.requests=new q(this.core,this.logger,"requests",F),this.engine=new Br(this)}static async init(t){const e=new O(t);return await e.initialize(),e}get context(){return Re(this.logger)}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.authKeys.init(),await this.requests.init(),await this.pairingTopics.init(),await this.engine.init(),this.logger.info("AuthClient Initialization Success"),this.logger.info({authClient:this})}catch(t){throw this.logger.info("AuthClient Initialization Failure"),this.logger.error(t.message),t}}}const Nr=O;export{Y as AUTH_CLIENT_CONTEXT,N as AUTH_CLIENT_DEFAULT_NAME,B as AUTH_CLIENT_PROTOCOL,x as AUTH_CLIENT_PUBLIC_KEY_NAME,F as AUTH_CLIENT_STORAGE_PREFIX,H as AUTH_CLIENT_VERSION,U as AUTH_REQUEST_EXPIRY_BOUNDARIES,Nr as AuthClient,Rr as BASE10,Ee as BASE16,Fr as BASE64,G as DEFAULT_RPC_URL,R as ENGINE_RPC_OPTS,ke as EXPIRER_CONTEXT,Ge as EXPIRER_DEFAULT_TTL,Je as EXPIRER_EVENTS,Xe as EXPIRER_STORAGE_VERSION,X as IAuthClient,J as IAuthEngine,be as UTF8,O as default,Tr as generateNonce,ye as hashMessage};
//# sourceMappingURL=index.es.js.map
