"use strict";Object.defineProperty(exports, "__esModule", {value: true});var V=Object.defineProperty,z=Object.defineProperties;var q=Object.getOwnPropertyDescriptors;var x=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var k=(s,e,t)=>e in s?V(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,c=(s,e)=>{for(var t in e||(e={}))Z.call(e,t)&&k(s,t,e[t]);if(x)for(var t of x(e))$.call(e,t)&&k(s,t,e[t]);return s},W=(s,e)=>z(s,q(e));var r=(s,e,t)=>new Promise((i,a)=>{var o=l=>{try{p(t.next(l))}catch(d){a(d)}},n=l=>{try{p(t.throw(l))}catch(d){a(d)}},p=l=>l.done?i(l.value):Promise.resolve(l.value).then(o,n);p((t=t.apply(s,e)).next())});var E="/sdk/2022-08-12/embedded-wallet",A= exports.WALLET_USER_ID_LOCAL_STORAGE_NAME =s=>`paperEwsWalletUserId-${s}`,B="walletToken",T= exports.AUTH_TOKEN_LOCAL_STORAGE_NAME =s=>`${B}-${s}`,Q="a",I= exports.DEVICE_SHARE_LOCAL_STORAGE_NAME =(s,e)=>`${Q}-${s}-${e}`,J= exports.DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED =s=>`${Q}-${s}`;var f=(t=>(t.USER_MANAGED="USER_MANAGED",t.AWS_MANAGED="AWS_MANAGED",t))(f||{}),K= exports.AuthProvider =(n=>(n.PAPER_EMAIL_OTP="PaperEmailOTP",n.GOOGLE="Google",n.TWITTER="Twitter",n.COGNITO="Cognito",n.AUTH0="Auth0",n.CUSTOM_JWT="CustomJWT",n))(K||{});var F=(t=>(t.LOGGED_OUT="Logged Out",t.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",t))(F||{}),P= exports.UserWalletStatus =(a=>(a.LOGGED_OUT="Logged Out",a.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",a.LOGGED_IN_NEW_DEVICE="Logged In, New Device",a.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",a))(P||{});var _sdkcommonutilities = require('@paperxyz/sdk-common-utilities');var H=new Map,u=class{constructor({clientId:e}){this.isSupported=typeof window!="undefined"&&!!window.localStorage,this.clientId=e}getItem(e){return r(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=H.get(e))!=null?t:null})}setItem(e,t){return r(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);H.set(e,t)})}removeItem(e){return r(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return r(this,null,function*(){yield this.setItem(T(this.clientId),e)})}getAuthCookie(){return r(this,null,function*(){return this.getItem(T(this.clientId))})}removeAuthCookie(){return r(this,null,function*(){return this.removeItem(T(this.clientId))})}saveDeviceShare(e,t){return r(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(I(this.clientId,t),e)})}getDeviceShare(){return r(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(I(this.clientId,e)):null})}removeDeviceShare(){return r(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(I(this.clientId,e)):!1})}getWalletUserId(){return r(this,null,function*(){return this.getItem(A(this.clientId))})}saveWalletUserId(e){return r(this,null,function*(){yield this.setItem(A(this.clientId),e)})}removeWalletUserId(){return r(this,null,function*(){return this.removeItem(A(this.clientId))})}};function _(s){return new Promise(e=>{setTimeout(e,s*1e3)})}var X={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},N=new Map,v=class{constructor({link:e,iframeId:t,container:i=document.body,iframeStyles:a,onIframeInitialize:o}){this.POLLING_INTERVAL_SECONDS=1.4;this.POST_LOAD_BUFFER_SECONDS=1;let n=document.getElementById(t),p=new URL(e),l="1.1.0";if(!l)throw new Error("Missing SDK_VERSION env var");if(p.searchParams.set("sdkVersion",l),!n||n.src!=p.href){if(!n){n=document.createElement("iframe");let d=c(c({},X),a);Object.assign(n.style,d),n.setAttribute("id",t),n.setAttribute("fetchpriority","high"),i.appendChild(n)}n.src=p.href,n.setAttribute("data-version",l),n.onload=this.onIframeLoadHandler(n,this.POST_LOAD_BUFFER_SECONDS,o)}this.iframe=n}onIframeLoadedInitVariables(){return r(this,null,function*(){return{}})}onIframeLoadHandler(e,t,i){return()=>r(this,null,function*(){yield new Promise((o,n)=>r(this,null,function*(){var d;let p=new MessageChannel;p.port1.onmessage=R=>{let{data:g}=R;return p.port1.close(),g.success?(N.set(e.src,!0),i&&i(),o(!0)):n(new Error(g.error))},yield _(t);let l="initIframe";(d=e==null?void 0:e.contentWindow)==null||d.postMessage({eventType:l,data:yield this.onIframeLoadedInitVariables()},`${_sdkcommonutilities.getPaperOriginUrl.call(void 0, )}${E}`,[p.port2])}))})}call(o){return r(this,arguments,function*({procedureName:e,params:t,showIframe:i=!1,injectRecoveryCode:a={isInjectRecoveryCode:!1}}){for(;!N.get(this.iframe.src);)yield _(this.POLLING_INTERVAL_SECONDS);return i&&(this.iframe.style.display="block",yield _(.005)),new Promise((p,l)=>{var R;if(a.isInjectRecoveryCode){let g=m=>r(this,null,function*(){var U,G;if(m.origin!==_sdkcommonutilities.getPaperOriginUrl.call(void 0, )||m.data.type!=="paper_getRecoveryCode"||typeof m.data.userWalletId!="string")return;let j=yield(U=a.getRecoveryCode)==null?void 0:U.call(a,m.data.userWalletId);(G=this.iframe.contentWindow)==null||G.postMessage({type:"paper_getRecoveryCode_response",recoveryCode:j},_sdkcommonutilities.getPaperOriginUrl.call(void 0, )),window.removeEventListener("message",g)});window.addEventListener("message",g)}let d=new MessageChannel;d.port1.onmessage=g=>r(this,null,function*(){let{data:m}=g;d.port1.close(),i&&(yield _(.1),this.iframe.style.display="none"),m.success?p(m.data):l(new Error(m.error))}),(R=this.iframe.contentWindow)==null||R.postMessage({eventType:e,data:t},`${_sdkcommonutilities.getPaperOriginUrl.call(void 0, )}${E}`,[d.port2])})})}destroy(){N.delete(this.iframe.src)}};var C=class extends v{constructor({clientId:t,customizationOptions:i}){super({iframeId:te,link:ee({clientId:t,path:E,queryParams:i}).href,container:document.body});this.clientId=t}onIframeLoadedInitVariables(){return r(this,null,function*(){let t=new u({clientId:this.clientId});return{authCookie:yield t.getAuthCookie(),deviceShareStored:yield t.getDeviceShare(),walletUserId:yield t.getWalletUserId(),clientId:this.clientId}})}};function ee({clientId:s,path:e,queryParams:t}){var a;let i=new URL(e,_sdkcommonutilities.getPaperOriginUrl.call(void 0, ));if(t)for(let o of Object.keys(t))i.searchParams.set(o,((a=t[o])==null?void 0:a.toString())||"");return i.searchParams.set("clientId",s),i}var te="paper-embedded-wallet-iframe";var h=class{constructor({querier:e,preLogin:t,postLogin:i}){this.LoginQuerier=e,this.preLogin=t,this.postLogin=i}sendPaperEmailLoginOtp(i){return r(this,arguments,function*({email:e,recoveryShareManagement:t}){yield this.preLogin();let{isNewUser:a,isNewDevice:o}=yield this.LoginQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:e,recoveryShareManagement:t}});return{isNewUser:a,isNewDevice:o}})}};var D=class extends h{loginWithPaperModal(){return r(this,null,function*(){yield this.preLogin();let e=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(e)})}loginWithPaperEmailOtp(t){return r(this,arguments,function*({email:e}){yield this.preLogin();let i=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:e,recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(i)})}verifyPaperEmailLoginOtp(i){return r(this,arguments,function*({email:e,otp:t}){let a=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:e,otp:t,recoveryShareManagement:"AWS_MANAGED"},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(a)})}};var w=class extends h{loginWithPaperModal(e){return r(this,null,function*(){yield this.preLogin();let t=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0,getRecoveryCode:e==null?void 0:e.getRecoveryCode}});return this.postLogin(t)})}loginWithPaperEmailOtp(i){return r(this,arguments,function*({email:e,recoveryCode:t}){yield this.preLogin();let a=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:e,recoveryCode:t},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(a)})}verifyPaperEmailLoginOtp(a){return r(this,arguments,function*({email:e,otp:t,recoveryCode:i}){let o=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:e,otp:t,recoveryCode:i},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(o)})}};var O=class{constructor({clientId:e,advancedOptions:t,querier:i,onAuthSuccess:a}){var o;this.clientId=e,this.advancedOptions={recoveryShareManagement:(o=t==null?void 0:t.recoveryShareManagement)!=null?o:"AWS_MANAGED"},this.AuthQuerier=i,this.localStorage=new u({clientId:e}),this.onAuthSuccess=a,this.userManagedLogin=new w({postLogin:n=>r(this,null,function*(){return this.postLogin(n)}),preLogin:()=>r(this,null,function*(){yield this.preLogin()}),querier:i}),this.awsManagedLogin=new D({postLogin:n=>r(this,null,function*(){return this.postLogin(n)}),preLogin:()=>r(this,null,function*(){yield this.preLogin()}),querier:i})}preLogin(){return r(this,null,function*(){yield this.logout()})}postLogin(i){return r(this,arguments,function*({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(e.cookieString)),yield this.onAuthSuccess({storedToken:e,walletDetails:t})})}loginWithJwtAuth(a){return r(this,arguments,function*({token:e,authProvider:t,recoveryCode:i}){yield this.preLogin();let o=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:e,authProvider:t,recoveryCode:i}});return this.postLogin(o)})}loginWithPaperModal(e){return r(this,null,function*(){return yield this.preLogin(),this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperModal():this.userManagedLogin.loginWithPaperModal(e)})}loginWithPaperEmailOtp(e){return r(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperEmailOtp({email:e.email}):this.userManagedLogin.loginWithPaperEmailOtp(e)})}sendPaperEmailLoginOtp(t){return r(this,arguments,function*({email:e}){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.sendPaperEmailLoginOtp({email:e,recoveryShareManagement:"AWS_MANAGED"}):this.userManagedLogin.sendPaperEmailLoginOtp({email:e})})}verifyPaperEmailLoginOtp(e){return r(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.verifyPaperEmailLoginOtp(e):this.userManagedLogin.verifyPaperEmailLoginOtp(e)})}logout(){return r(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),i=yield this.localStorage.removeWalletUserId();return{success:e||t||i}})}};var _providers = require('@ethersproject/providers');var L=class{constructor({chain:e,clientId:t,querier:i}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=i}callContract(a){return r(this,arguments,function*({contractAddress:e,methodArgs:t,methodInterface:i}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:e,method:{args:t,stub:i}}})})}};var _abstractsigner = require('@ethersproject/abstract-signer');var _properties = require('@ethersproject/properties');var y=class extends _abstractsigner.Signer{constructor({provider:t,clientId:i,querier:a}){var o;super();this.DEFAULT_ETHEREUM_CHAIN_ID=5;this.clientId=i,this.querier=a,this.endpoint=(o=t.connection)==null?void 0:o.url,_properties.defineReadOnly.call(void 0, this,"provider",t)}getAddress(){return r(this,null,function*(){let{address:t}=yield this.querier.call({procedureName:"getAddress",params:void 0});return t})}signMessage(t){return r(this,null,function*(){var o,n,p,l;let i=yield(o=this.provider)==null?void 0:o.getNetwork();i&&i._defaultProvider;let{signedMessage:a}=yield this.querier.call({procedureName:"signMessage",params:{message:t,chainId:(l=(p=yield(n=this.provider)==null?void 0:n.getNetwork())==null?void 0:p.chainId)!=null?l:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return a})}signTransaction(t){return r(this,null,function*(){var a,o,n;let{signedTransaction:i}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:t,chainId:(n=(o=yield(a=this.provider)==null?void 0:a.getNetwork())==null?void 0:o.chainId)!=null?n:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return i})}_signTypedData(t,i,a){return r(this,null,function*(){var n,p,l;let{signedTypedData:o}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:t,types:i,message:a,chainId:(l=(p=yield(n=this.provider)==null?void 0:n.getNetwork())==null?void 0:p.chainId)!=null?l:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return o})}connect(t){return new y({clientId:this.clientId,provider:t,querier:this.querier})}};var M=class{constructor({clientId:e,chain:t,querier:i}){this.clientId=e,this.chain=t,this.walletManagerQuerier=i,this.gasless=new L({chain:t,clientId:e,querier:i}),this.localStorage=new u({clientId:e})}postWalletSetUp(o){return r(this,arguments,function*({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:i,walletUserId:a}){return i||(yield this.localStorage.saveDeviceShare(e,a)),{walletAddress:t}})}getUserWalletStatus(){return r(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:W(c({},e.user),{wallet:this})}:e})}setChain(t){return r(this,arguments,function*({chain:e}){this.chain=e,this.gasless=new L({chain:e,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return r(this,null,function*(){var i;return new y({clientId:this.clientId,provider:_providers.getDefaultProvider.call(void 0, (i=e==null?void 0:e.rpcEndpoint)!=null?i:_sdkcommonutilities.ChainToPublicRpc[this.chain]),querier:this.walletManagerQuerier})})}};var b=class{constructor({clientId:e,chain:t,styles:i,advancedOptions:a}){this.clientId=e,this.querier=new C({clientId:e,customizationOptions:i}),this.wallet=new M({clientId:e,chain:t,querier:this.querier}),this.auth=new O({clientId:e,advancedOptions:c({recoveryShareManagement:"USER_MANAGED"},a!=null?a:{}),querier:this.querier,onAuthSuccess:o=>r(this,null,function*(){return yield this.wallet.postWalletSetUp(W(c({},o.walletDetails),{walletUserId:o.storedToken.authDetails.userWalletId})),{user:{status:"Logged In, Wallet Initialized",authDetails:o.storedToken.authDetails,wallet:this.wallet,walletAddress:o.walletDetails.walletAddress}}})})}getUser(){return r(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return c({status:"Logged In, Wallet Initialized"},e.user)}})}};exports.AUTH_TOKEN_LOCAL_STORAGE_NAME = T; exports.AuthProvider = K; exports.DEVICE_SHARE_LOCAL_STORAGE_NAME = I; exports.DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED = J; exports.PaperEmbeddedWalletSdk = b; exports.RecoveryShareManagement = f; exports.UserStatus = F; exports.UserWalletStatus = P; exports.WALLET_USER_ID_LOCAL_STORAGE_NAME = A;
//# sourceMappingURL=index.js.map